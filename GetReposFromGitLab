# --- Microsoft 365 SMTP test (smtp.office365.com:587 + STARTTLS) ---

$smtpServer = "smtp.office365.com"
$port       = 587

$from = "john.doe@company.com"
$to   = "john.doe@company.com"
$subject = "SMTP test from PowerShell"
$body    = "If you received this, SMTP submission works. Sent at $(Get-Date)."

# Prompt securely for creds
$cred = Get-Credential -UserName $from -Message "Enter your Microsoft 365 credentials"

# Build and send
$msg = New-Object System.Net.Mail.MailMessage($from, $to, $subject, $body)
$smtp = New-Object System.Net.Mail.SmtpClient($smtpServer, $port)
$smtp.EnableSsl = $true                 # STARTTLS on port 587
$smtp.DeliveryMethod = [System.Net.Mail.SmtpDeliveryMethod]::Network
$smtp.UseDefaultCredentials = $false
$smtp.Credentials = $cred.GetNetworkCredential()

try {
    $smtp.Send($msg)
    "Sent OK."
}
catch {
    "Send FAILED: $($_.Exception.Message)"
    if ($_.Exception.InnerException) { "Inner: $($_.Exception.InnerException.Message)" }
}
finally {
    $msg.Dispose()
    $smtp.Dispose()
}
